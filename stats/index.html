<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="反射 × 脳トレ（計算・記憶・論理） 4人10問スコアバトル">
  <title>トップ | Reflex Quiz Arena</title>
  <link rel="stylesheet" href="/assets/style.css" />
  <link rel="icon" href="/assets/favicon.svg" type="image/svg+xml" />
</head>
<body>
  <div class="wrap">
    <nav class="nav">
  <a class="brand" href="/"><span class="brandMark">RQA</span><span class="brandText">Reflex Quiz Arena</span></a>
  <div class="navLinks">
    <a href="/play/">遊ぶ</a>
    <a href="/rules/">ルール</a>
    <a href="/mode/free/">フリー対戦</a>
    <a href="/mode/rated/">レート対戦</a>
    <a href="/faq/">FAQ</a>
    <a href="/story/">ストーリー</a>
    <a href="/stats/">戦績</a>
  </div>
</nav>
    <main class="main">
<div class="hero">
  <noscript>
    <div class="notice bad" style="margin-bottom:10px">戦績の集計表示にはJavaScriptが必要です。</div>
  </noscript>
  <h1 class="h1">戦績</h1>
  <p class="p">プレイ履歴から、正解率や得意ジャンルの傾向を確認できます（端末のローカル保存）。</p>
  <div class="btnRow">
    <a class="btn primary" href="/play/">遊ぶ</a>
    <a class="btn ghost" href="/rules/">ルール</a>
  </div>
</div>

<div class="grid grid2" style="margin-top:12px">
  <section class="card" id="summaryCard">
    <div class="h2">サマリー</div>
    <div class="small muted">まだ戦績がありません。まずは「遊ぶ」から10問プレイしてください。</div>
  </section>

  <section class="card">
    <div class="h2">メモ</div>
    <ul class="list">
      <li>戦績はこの端末のブラウザに保存されます（サーバー送信なし）。</li>
      <li>フリー/レート/CPU/練習の結果をまとめて集計します。</li>
      <li>同点判定は「合計スコア → 正解数 → 総回答時間（短い方）」です。</li>
    </ul>
    <div class="hr"></div>
    <div class="btnRow">
      <button class="btn danger" id="clearBtn">戦績をリセット</button>
    </div>
    <div class="small" style="margin-top:8px">※リセットすると元に戻せません。</div>
  </section>
</div>

<div class="grid grid2" style="margin-top:12px">
  <section class="card" id="genreCard">
    <div class="h2">ジャンル別</div>
    <div class="small muted">まだ戦績がありません。まずは「遊ぶ」から10問プレイしてください。</div>
  </section>

  <section class="card" id="modeCard">
    <div class="h2">モード別</div>
    <div class="small muted">まだ戦績がありません。まずは「遊ぶ」から10問プレイしてください。</div>
  </section>
</div>

<div class="grid" style="margin-top:12px">
  <section class="card" id="recentCard">
    <div class="h2">最近の試合</div>
    <div class="small muted">まだ戦績がありません。まずは「遊ぶ」から10問プレイしてください。</div>
  </section>
</div>

<script>
(function(){
  const GENRE_LABEL = { calc:"計算", memory:"記憶", logic:"論理" };

  function readStats(){
    try{
      const raw = localStorage.getItem("rqa_stats_v1");
      if (!raw) return [];
      const arr = JSON.parse(raw);
      return Array.isArray(arr) ? arr : [];
    }catch(e){ return []; }
  }
  function pct(a,b){
    if (!b) return "—";
    return (Math.round((a/b)*1000)/10).toFixed(1) + "%";
  }
  function fmtDate(ts){
    try{
      const d = new Date(ts);
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const da = String(d.getDate()).padStart(2,"0");
      const hh = String(d.getHours()).padStart(2,"0");
      const mm = String(d.getMinutes()).padStart(2,"0");
      return `${y}-${m}-${da} ${hh}:${mm}`;
    }catch(e){ return ""; }
  }

  function render(){
    const stats = readStats();
    const totalMatches = stats.length;

    const sum = {
      correct: 0,
      total: 0,
      score: 0,
      totalTimeSec: 0,
      byGenre: { calc:{c:0,t:0}, memory:{c:0,t:0}, logic:{c:0,t:0} },
      byMode: {}
    };

    for (const s of stats){
      sum.score += (s.score||0);
      sum.correct += (s.correct||0);
      sum.total += (s.totalQ||0);
      sum.totalTimeSec += (s.totalTimeSec||0);

      const mode = s.modeKey || "unknown";
      if (!sum.byMode[mode]) sum.byMode[mode] = { matches:0, correct:0, total:0 };
      sum.byMode[mode].matches++;
      sum.byMode[mode].correct += (s.correct||0);
      sum.byMode[mode].total += (s.totalQ||0);

      const g = s.genre || {};
      for (const key of ["calc","memory","logic"]){
        if (g[key]){
          sum.byGenre[key].c += (g[key].correct||0);
          sum.byGenre[key].t += (g[key].total||0);
        }
      }
    }

    const avgScore = totalMatches ? Math.round(sum.score/totalMatches) : 0;
    const acc = pct(sum.correct, sum.total);
    const avgTimePerQ = sum.total ? Math.round((sum.totalTimeSec/sum.total)*10)/10 : 0;

    const summaryEl = document.getElementById("summaryCard");
    summaryEl.innerHTML = `
      <div class="h2">サマリー</div>
      <div class="kpis">
        <div class="kpi"><div class="label">試合数</div><div class="value">${totalMatches}</div></div>
        <div class="kpi"><div class="label">正解率</div><div class="value">${acc}</div></div>
        <div class="kpi"><div class="label">平均スコア</div><div class="value">${avgScore}</div></div>
        <div class="kpi"><div class="label">平均 解答時間/問</div><div class="value">${sum.total ? avgTimePerQ+"秒" : "—"}</div></div>
      </div>
      <div class="small" style="margin-top:8px">※時間は「試合中に使った総回答時間」を問題数で割った値です（試合中には表示しません）。</div>
    `;

    // Genre card
    const genreRows = ["calc","memory","logic"].map(k=>{
      const c = sum.byGenre[k].c;
      const t = sum.byGenre[k].t;
      return `<tr><td>${GENRE_LABEL[k]}</td><td>${pct(c,t)}</td><td>${c}/${t||0}</td></tr>`;
    }).join("");
    document.getElementById("genreCard").innerHTML = `
      <div class="h2">ジャンル別</div>
      <table class="table">
        <thead><tr><th>ジャンル</th><th>正解率</th><th>正解/出題</th></tr></thead>
        <tbody>${genreRows}</tbody>
      </table>
    `;

    // Mode card
    const modeLabel = {
      practice:"練習（ソロ）",
      practice_calc:"練習（計算）",
      practice_memory:"練習（記憶）",
      practice_logic:"練習（論理）",
      cpu_easy:"CPU（弱）", cpu_mid:"CPU（中）", cpu_hard:"CPU（強）", cpu_oni:"CPU（鬼）",
      free:"フリー", rated:"レート"
    };
    function labelOfMode(m){
      if (modeLabel[m]) return modeLabel[m];
      if (String(m).startsWith("story_")){
        const n = String(m).replace("story_", "");
        return `ストーリー STAGE ${n}`;
      }
      return m || "—";
    }

    const modes = Object.keys(sum.byMode);
    modes.sort((a,b)=> (sum.byMode[b].matches - sum.byMode[a].matches));
    const modeRows = modes.map(m=>{
      const x = sum.byMode[m];
      return `<tr><td>${labelOfMode(m)}</td><td>${x.matches}</td><td>${pct(x.correct,x.total)}</td></tr>`;
    }).join("");
    document.getElementById("modeCard").innerHTML = `
      <div class="h2">モード別</div>
      <table class="table">
        <thead><tr><th>モード</th><th>試合</th><th>正解率</th></tr></thead>
        <tbody>${modeRows || `<tr><td colspan="3" class="small muted">まだ戦績がありません。</td></tr>`}</tbody>
      </table>
    `;

    // Recent
    const recent = stats.slice().sort((a,b)=>(b.ts||0)-(a.ts||0)).slice(0,12);
    const recRows = recent.map(s=>{
      const label = labelOfMode(s.modeKey);
      const time = (s.totalTimeSec!=null) ? `${Math.round(s.totalTimeSec)}秒` : "—";
      return `<tr>
        <td>${fmtDate(s.ts)}</td>
        <td>${label}</td>
        <td>${s.rank||"—"}位</td>
        <td>${s.score||0}</td>
        <td>${(s.correct||0)}/${(s.totalQ||10)}</td>
        <td>${time}</td>
      </tr>`;
    }).join("");

    document.getElementById("recentCard").innerHTML = `
      <div class="h2">最近の試合</div>
      <table class="table">
        <thead><tr><th>日時</th><th>モード</th><th>順位</th><th>スコア</th><th>正解</th><th>総回答時間</th></tr></thead>
        <tbody>${recRows || `<tr><td colspan="6" class="small muted">まだ戦績がありません。まずは10問プレイしてみてください。</td></tr>`}</tbody>
      </table>
      <div class="small" style="margin-top:8px">※総回答時間は結果画面のみで扱う設計です。</div>
    `;

    document.getElementById("clearBtn").onclick = ()=>{
      if (!confirm("戦績をリセットします。よろしいですか？")) return;
      localStorage.removeItem("rqa_stats_v1");
      render();
    };
  }

  render();
})();
</script>
</main>
    <footer class="footer">
  <div class="footerGrid">
    <div>
      <div class="footerTitle">Reflex Quiz Arena</div>
      <div class="muted">反射 × 脳トレ（計算・記憶・論理） 4人10問スコアバトル</div>
    </div>
    <div class="footerLinks">
      <a href="/privacy/">プライバシーポリシー</a>
      <a href="/contact/">お問い合わせ</a>
    </div>
  </div>
  <div class="tiny muted">© 2026 Reflex Quiz Arena</div>
</footer>
  </div>
  <script src="/assets/config.js"></script>
</body>
</html>
